<!DOCTYPE html>
<html>
<head>
<title>Hello canvas</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<style>
html, body {
	height: 100%;
	width: 100%;
	margin: 0;
	padding: 0;
}

#canvas {
	height: 100%;
	width: 100%;
	position: absolute;
}
</style>
</head>
<body>
<canvas id="canvas">
	Your browser does not support HTML5 canvas
</canvas>

<script>
var serverTime = 0;
var num = 0;
var testBoard = function() {
	// TODO Get it from the network!
	var primitives = []
	switch (num) {
	default:
		primitives.push({ color: '#cccccc', strokeWidth: 1, points: [0, 100, 100, 200, 200, 100] });
	case 1:
		primitives.push({ color: '#FF0000', strokeWidth: 1, points: [0, 50, 100, 150, 200, 50] });
	case 0:
		primitives.push({ color: '#000000', strokeWidth: 1, points: [0, 0, 100, 100, 200, 0] });
	}
	num++;
	return { width: 800, height: 480, primitives: primitives };
};

var paint = function(board, canvas) {
	canvas.width = window.innerWidth; // Clear and resize canvas
	canvas.height = window.innerHeight;

	console.log('Redrawing: ' + board.width + ' ' + board.height);

	// TODO bounds checking etc
	var context = canvas.getContext('2d');
	var windowWidth = window.innerWidth;
	var windowHeight = window.innerHeight;
	$.each(board.primitives, function(index, primitive) {
		context.beginPath();
		for (var i = 0; i < (primitive.points.length / 2); i++) {
			var point = primitive.points.slice(i * 2, (i * 2) + 2);
			if (i == 0) {
				context.moveTo(point[0], point[1]); // don't paint on first point
			} else {
				context.lineTo(point[0], point[1]);
			}
		}
//		context.strokeStyle = path.color;
		context.strokeStyle = '#CCCCCC';
		context.stroke();
	});
	context.strokeRect(0, 0, windowWidth/2, windowHeight/2);
	if (serverTime)
		context.fillText("The time sponsored by Android will read: " + serverTime, 50, 50);
};

$(document).ready(function() {
	var fetchTime = function() {
		$.get('/time', function(time) {
			$('#time').html(time);
			serverTime = time;
		});
	};
	window.setInterval(fetchTime, 1000);
	
	var canvas = $('#canvas')[0];
	var refreshBoard = function() {
		$.get('/board.json', function(board) {
			paint(board, canvas);
		});
	};
	window.setInterval(refreshBoard, 1000);
});

$(window).resize(function() {
	paint();
});
</script>
</body>
</html>