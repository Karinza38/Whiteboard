<!DOCTYPE html>
<html>
<head>
<title>Hello canvas</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<style>
html, body {
	height: 100%;
	width: 100%;
	margin: 0;
	padding: 0;
}

#canvas {
	margin-left: auto;
	margin-right: auto;
	position: absolute;
}
</style>
</head>
<body>
<div>
<canvas id="canvas">
	Your browser does not support HTML5 canvas
</canvas>
</div>

<div>
<a id="download" href="">Download</a>
</div>
<script>
var serverTimeStamp = 0;

var num = 0;
var testBoard = function() {
	var primitives = []
	for (var i = 0; i < num; i++) {
		var baseY = i * 10;
		primitives.push({ color: '#cccccc', strokeWidth: 1, points: [i, baseY + 100, 100, i * 2 + 200, 200, i + 100] });
	}
	num++;
	return { width: 800, height: 480, primitives: primitives };
};

var lastBoard;
var scaleFactor = 0;

// TODO: Stop resize from running constantly.
var resize = function() {
	var board = lastBoard;

	// Set canvas coordinate system to the same as the device and reset the canvas.
	var canvas = $('#canvas')[0];
	canvas.width = board.width;
	canvas.height = board.height;

	// Use CSS to scale the canvas to the window.
	boardAspect = board.width / board.height;
	windowAspect = window.innerWidth / window.innerHeight;

	if (boardAspect > 1) {
		newWidth = window.innerWidth;
		newHeight = window.innerWidth / boardAspect;
	}
	else {
		newHeight = window.innerHeight;
		newWidth = window.innerHeight / boardAspect;
	}

	canvas.width = newWidth
	canvas.height = newHeight
	scaleFactor = canvas.width/board.width;
}

var paint = function() {
	if (scaleFactor == 0)
		resize();

	var board = lastBoard;

	// Reset the canvas.
	var canvas = $('#canvas')[0];
	canvas.width = canvas.width;
	canvas.height = canvas.height;

	var context = canvas.getContext('2d');
	context.save();

	context.lineCap = 'round';
	context.lineJoin = 'round';
	context.scale(scaleFactor, scaleFactor);
	$.each(board.primitives, function(index, primitive) {
		if (!primitive.points)
			return false;

		context.beginPath();
		for (var i = 0; i < (primitive.points.length / 2); i++) {
			var point = primitive.points.slice(i * 2, (i * 2) + 2);
			if (i == 0) {
				context.moveTo(point[0], point[1]); // don't paint on first point.
			} else {
				context.lineTo(point[0], point[1]);
			}
		}
		context.lineWidth = primitive.strokeWidth * 1.2;
		context.strokeStyle = '#' + primitive.color;
		context.stroke();
	});
	context.restore();

	context.save();
	context.strokeRect(0, 0, canvas.width, canvas.height);
	context.restore();
};

$(document).ready(function() {
	var fetchTimeStamp = function() {
		$.get('/timestamp', function(time) {
			serverTimeStamp = time;
		});
	};
	
	var canvas = $('#canvas')[0];
	var refreshBoard = function() {
		$.get('/board.json', function(board) {
//			lastBoard = testBoard();
			lastBoard = board;
			paint();
		});
	};
	
	//window.setInterval(fetchTimeStamp, 1000);
	window.setInterval(refreshBoard, 500);
	paint();
});

$(window).resize(function() {
	scaleFactor = 0;
	paint();
});
</script>
</body>
</html>
