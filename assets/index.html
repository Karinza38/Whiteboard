<!DOCTYPE html>
<html>
<head>
<title>Hello canvas</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<style>
html, body {
	height: 100%;
	width: 100%;
	margin: 0;
	padding: 0;
}

#canvas {
	margin-left: auto;
	margin-right: auto;
	position: absolute;
}
</style>
</head>
<body>
<canvas id="canvas">
	Your browser does not support HTML5 canvas
</canvas>

<script>
var serverTime = 0;
var num = 0;
var testBoard = function() {
	// TODO Get it from the network!
	var primitives = []
	switch (num) {
	default:
		primitives.push({ color: '#cccccc', strokeWidth: 1, points: [0, 100, 100, 200, 200, 100] });
	case 1:
		primitives.push({ color: '#FF0000', strokeWidth: 1, points: [0, 50, 100, 150, 200, 50] });
	case 0:
		primitives.push({ color: '#000000', strokeWidth: 1, points: [0, 0, 100, 100, 200, 0] });
	}
	num++;
	return { width: 800, height: 480, primitives: primitives };
};

var lastBoard;

var paint = function() {
	var board = lastBoard;
	console.log('Redrawing: ' + board.width + ' ' + board.height);
	
	// Set canvas coordinate system to the same as the device and reset the canvas.
	var canvas = $('#canvas')[0];
	canvas.width = board.width;
	canvas.height = board.height;

	// Use CSS to scale the canvas to the window.
	if (board.width > board.height) {
		newWidth = '100%';
		var widthScaleFactor = board.width / window.innerWidth;
		newHeight = board.width / widthScaleFactor
		newHeight + 'px';
	}
	else {
		newHeight = '100%';
		var heightScaleFactor = board.height / window.innerHeight;
		newWidth = board.height / heightScaleFactor
		newHeight + 'px';
	}

	$(canvas).css( { height: newHeight, width: newWidth } );

	var context = canvas.getContext('2d');
	$.each(board.primitives, function(index, primitive) {
		context.beginPath();
		for (var i = 0; i < (primitive.points.length / 2); i++) {
			var point = primitive.points.slice(i * 2, (i * 2) + 2);
			if (i == 0) {
				context.moveTo(point[0], point[1]); // don't paint on first point.
			} else {
				context.lineTo(point[0], point[1]);
			}
		}
		context.strokeStyle = '#' + primitive.color;
		context.stroke();
	});
	context.strokeRect(0, 0, canvas.width, canvas.height);
	if (serverTime)
		context.fillText("The time sponsored by Android will read: " + serverTime, 50, 50);
};

$(document).ready(function() {
	var fetchTime = function() {
		$.get('/time', function(time) {
			$('#time').html(time);
			serverTime = time;
		});
	};
	window.setInterval(fetchTime, 1000);
	
	var canvas = $('#canvas')[0];
	var refreshBoard = function() {
		$.get('/board.json', function(board) {
			lastBoard = board;
			paint();
		});
	};
	window.setInterval(refreshBoard, 1000);
});

$(window).resize(function() {
	paint();
});
</script>
</body>
</html>
