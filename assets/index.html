<!DOCTYPE html>
<html>
<head>
<title>Wifi Whiteboard by Team Win</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<style>
html, body {
	height: 100%;
	width: 100%;
	margin: 0;
	padding: 0;
}

h1 {
	display:inline;
}

#download {
	text-align: right;
}

#header {
	border: 1px red solid;
}

#container {
	border: 1px green solid;
	width: 800px;
	margin-left: auto;
	margin-right: auto;
}

#canvas {
	border: 1px blue dashed;
}
</style>
</head>
<body>
<div id='header'>
<h1>Wifi Whiteboard by Team Win</h1>
<a id="download" href="">Download as a PNG image</a>
</div>
<div id="container">
<canvas id="canvas">
	Your browser does not support HTML5 canvas
</canvas>
</div>

<script>
var lastPrimitivesCount = 0;
var lastBoard;

var paint = function() {
	var board = lastBoard;

	// Set canvas coordinate system and reset the canvas.
	var canvas = $('#canvas')[0];
	containerWidth = window.innerWidth * 0.9;
	containerHeight = window.innerHeight * 0.8;
	windowAspectRatio = containerWidth / containerHeight;
	if (windowAspectRatio < board.aspectRatio) {
		canvas.width = window.innerWidth * 0.9;
		canvas.height = canvas.width / board.aspectRatio;
	}
	else {
		canvas.height = window.innerHeight * 0.8;
		canvas.width = canvas.height * board.aspectRatio;
	}

	$('#container').css( { width: canvas.width + 2 + 'px' } );

	var context = canvas.getContext('2d');
	context.save();

	context.lineCap = 'round';
	context.lineJoin = 'round';
	context.scale(canvas.height, canvas.height);
	$.each(board.primitives, function(index, primitive) {
		if (!primitive.points)
			return false;

		lastPrimitivesCount = primitive.points.length;

		context.beginPath();
		var lastX = 0;
		var lastY = 0;
		for (var point = 0; point < primitive.points.length; point+=2) {
			var x = primitive.points[point] * board.aspectRatio;
			var y = primitive.points[point+1];
			if (lastX && lastY)
				context.quadraticCurveTo(lastX, lastY, (x + lastX) / 2, (y + lastY) / 2);
			else
				context.moveTo(x, y);
			lastX = x;
			lastY = y;
		}
		context.lineWidth = primitive.strokeWidth;
		context.strokeStyle = '#' + primitive.color;
		context.stroke();
	});
	context.restore();

	var pngMime = 'image/png';
	var pngData = canvas.toDataURL(pngMime);
	var pngDownload = pngData.replace(pngMime, 'image/octet-stream')
	$('#download').attr('href', pngDownload);
};

$(document).ready(function() {
	var checkModified = function() {
		$.get('/modified/' + lastPrimitivesCount, function(modified) {
			lastPrimitivesCount = modified;
		});
	};
	
	var canvas = $('#canvas')[0];
	var refreshBoard = function() {
		$.get('/board.json', function(board) {
			lastBoard = board;
			paint();
		});
	};
	
	//window.setInterval(checkModified, 1000);
	window.setInterval(refreshBoard, 500);
	paint();
});

$(window).resize(function() {
	paint();
});
</script>
</body>
</html>
